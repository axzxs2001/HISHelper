@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>需求发布</title>
    <link href="~/css/bootstrap.css" rel="stylesheet" />
    <link href="~/css/register_index.css" rel="stylesheet" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <title>需求发布</title>
    <style>
        .bd {
            width: 102%;
        }
    </style>
</head>

<body>
    <!--上-->
    <div id="top">
        <div class="green">
            <div class="wrap">
                <ul class="ulz lt">
                    <li class="cp lt">产品需求发布</li>
                </ul>
                <ul class="uly rt">
                    <!--<li class="tp rt"><img src="img/a_03.png" alt=""></li>-->
                    <li class="sub rt"><p>subjec：pc</p><p> Publisher：<span id="implementerid">@User.Identity.Name</span></p><p>date：<span id="shijiandata">2017/7/31</span></p></li>
                    <li class="x rt"><span></span></li>
                    <li class="wx rt">微信公众号 <p>version:1.0.0.0</p> </li>
                </ul>

            </div>
        </div>
    </div>
    <!--左四个钮-->
    <div class="hahaha">
        <ul>
            <li class="a_p"><a href="#"><img src="~/images/Demand/a_07.png" /></a></li>
            <li class="b_p"><a href="http://localhost:61110/productdemand"><img src="~/images/Demand/a_13.png" /></a></li>
            <li class="c_p"><a href="http://localhost:61110/demand"><img src="~/images/Demand/a_15.png" /></a></li>
            <li class="d_p"><a href="#"><img src="~/images/Demand/a_21.png" /></a></li>
        </ul>
    </div>
    <!--中-->
    <div id="content">
        <div class="msn">
            <div class="pc_top">
                <div class="lt name">
                    <div class="black">
                        <span>基本信息</span>
                    </div>

                    <p><img src="~/images/Demand/1.png" /></p>
                    <form action="" class="f_one">
                        <ul>
                            <li>
                                <img src="~/images/Demand/a_31.png" class="im" alt="" /><span class="span_1">院方名称&nbsp;<a></a></span>
                                <input type="text" name="" class="inpp" id="username" placeholder="请输入医院名称">
                            </li>
                            <li>
                                <img src="~/images/Demand/a_17.png" class="im" alt="" /><span class="span_1">&nbsp; 姓&nbsp;&nbsp;&nbsp;&nbsp;名&nbsp;&nbsp; <a></a></span>
                                <input type="text" name="" id="producer" class="inpp" placeholder="请输入负责人姓名">
                            </li>
                            <li>
                                <img src="~/images/Demand/a_24.png" class="im" alt="" /><span class="span_1">&nbsp;联系方式&nbsp;<a></a></span>
                                <input type="text" name="" class="inpp" id="information" placeholder="请输入负责人联系方式">
                            </li>
                            <li>
                                <img src="~/images/Demand/dizhi.png" class="im" alt="" /><span class="span_1">院方地址&nbsp;<a></a></span>
                                <input type="text" name="" class="inpp" id="address" placeholder="请输入院方地址">
                            </li>
                            @*<li>
                                    <img src="~/images/Demand/a_28.png"  class="im" alt=""/><span class="span_1">电子邮件<a></a></span>
                                    <input type="text" name="" class="inpp" placeholder="请输入电子邮件">
                                </li>*@

                        </ul>
                    </form>
                </div>
                <div class="rt ">
                    <img src="~/images/Demand/a_11.png" alt="" class="a_11" />
                </div>
            </div>
            <div class="pc_bot">

                <div class="name rt nas">
                    <div class="black la ">
                        <span>需求信息</span>
                        <p>
                            <img src="~/images/Demand/2.png" class="pp" alt="" />
                        </p>
                    </div>

                    <form action="" class="f_one">
                        <ul class="ulyy">
                            <li>
                                <img src="~/images/Demand/a_39.png" class="im" alt="" /><span class="span_1">需求名称<a></a></span>
                                <input type="text" name="" id="demandname" class="inpp" placeholder="必填：请输入需求名称">
                            </li>
                            <li>
                                <img src="~/images/Demand/chanpin.png" class="im" alt="" /><span class="span_1">产品名称<a></a></span>
                                <select name="" id="productname" class="inpps">
                                    <option value="0" style="color:#999">请选择产品名称</option>

                                </select>
                            </li>
                            <li>
                                <img src="~/images/Demand/a_43.png" class="im" alt="" /><span class="span_1"> 优  先 级 <a></a></span>
                                <!--<input type="text" name="" class="inpp" value="必填：请选择需求优先级">-->
                                <select name="" id="priority" class="inpps">
                                    <option value="0" style="color:#999">请选择优先级</option>
                                    <option value="">A</option>
                                    <option value="">B</option>
                                    <option value="">C</option>
                                    <option value="">S</option>
                                </select>
                            </li>
                            <li>
                                <img src="~/images/Demand/a_46.png" class="im" alt="" /><span class="span_1">交付部门<a></a></span>
                                <!--<input type="text" name="" class="inpp" value="必填：请选择交付的部门">-->
                                <select name="" id="bumen" class="inpps">
                                    <option value="0" style="color:#666">请选择交付的部门</option>
                                    @*<option value="">必填：请选择交付的部门</option>
                                        <option value="">必填：请选择交付的部门</option>*@
                                </select>
                            </li>
                            @*<li>
                                    <img src="~/images/Demand/a_48.png" class="im" alt="" /><span class="span_1">发布时间<a></a></span>

                                    <select name="" id="" class="inpps">
                                        <option value="">必填：请选择需求优先级</option>
                                        <option value="">必填：请选择需求优先级</option>
                                        <option value="">必填：请选择需求优先级</option>
                                    </select>
                                </li>*@
                        </ul>

                    </form>

                </div>
                <div class="cofes rt">
                    <img src="~/images/Demand/a_36.png" alt="" class="a_36" />
                </div>
            </div>
            <div class="foot">
                <p>请在下方输入需求详细信息（ 慎重！）</p>
                <!--百度编辑器-->
                <div class="bd">
                    <script id="editor" type="text/plain" style="width:100%; height:350px;overflow:auto">
                    </script>
                </div>
                <!--button-->
                <div class="buttt rt">
                    <img src="~/images/Demand/a_67.png" style="cursor:pointer" title="清空按钮" onclick="qingkong()" />
                    <img src="~/images/Demand/lccc.png" onclick="Insertdraft()" />
                    <img src="~/images/Demand/a_69.png" style="cursor:pointer" onclick="InsertUser()" id="tianjia" />
                </div>
            </div>
        </div>
    </div>
    <div class="haha">
        <ul>
            <li class="def"><a href="#"> <img src="~/images/Demand/a_60.png" /></a></li>
            <li class="abc"><a href="#"><img src="~/images/Demand/a_55.png" /></a></li>
        </ul>
    </div>
    <!--下-->
    <div id="sos">
        <ul class="uubb">
            <li class="lt"><a href="#">帮助中心</a></li>
            <li class="lt"><a href="#">关于我们</a></li>
            <li class="lt"><a href="#">注意事项</a></li>
        </ul>
        <p class="pp_1 pp_2"> Copyright 2017-08-01 大连医卫 New technology research center</p>

    </div>
    <script src="~/lib/jquery/dist/jquery.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.js"></script>
    <script src="~/js/jquery.form.js"></script>
    <script src="~/layer/layer.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/lib/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/lib/ueditor/ueditor.all.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/lib/ueditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript">
        var thisURL = document.URL;
        var getdemval = thisURL.split('?')[1];
        var showdemval = getdemval.split("=")[1];
        $(function () {
            SelectBumen();
            PostProducts();
            if (showdemval > 0) {
                SelectDem();
            }
            else {
                createEditor();
                datetime();
            }
        });
        //#region 上传图片
        function upload() {
            $("#form").ajaxSubmit({
                type: "POST",//提交类型 
                url: "/uploadimage",//请求地址  
                success: function (data) {//请求成功后的函数  
                    $("#myimg").attr("src", data[0]);
                    $("#imgpath").val(data[0]);
                },
                error: function (data) { alert(data); },//请求失败的函数  
                async: true
            });
        }
        //#endregion

        //#region  百度编辑器
        //创建编辑器
        function createEditor() {
            UE.getEditor('editor');
            UE.getEditor('editor').addListener('ready', function (editor) {
                //加载内容
            });
        }
        //#endregion

        //#region 获取当前时间
        var date = (new Date()).getTime();
        function datetime() {
            var now = new Date();
            var year = now.getFullYear();
            var month = now.getMonth();
            var day = now.getDate();
            var hour = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();
            var tolocalestring = now.toLocaleTimeString();
            $("#shijiandata").html("" + year + "/" + (month + 1) + "/" + day + "");
        }
        //#endregion

        //#region 动态添加部门
        function SelectBumen() {
            var str = '';
            $.ajax({
                type: 'POST',
                url: '/seldepartments',
                data: {},
                success: function (dataBack) {
                    str += "请选择交付部门";
                    $(dataBack.data).each(function (index, item) {
                        str += '<option value="' + item["id"] + '">' + item["departmentname"] + '</option>';
                    });
                    $('#bumen').append(str);
                }
            });
        }
        //#endregion

        //#region 动态添加产品名称
        function PostProducts() {
            var str = '';
            $.ajax({
                type: 'POST',
                url: '/products',
                data: {},
                success: function (dataBack) {
                    str += "请选择产品名称";
                    $(dataBack.data).each(function (index, item) {
                        str += '<option value="' + item["id"] + '">' + item["productname"] + '</option>';
                    });
                    $('#productname').append(str);
                }
            });
        }
        //#endregion

        //#region  通过名称查询ID
        var ID;
        var Character;
        function InsertUser() {
            $.ajax({
                type: "POST",
                url: "/chaxunid",
                data: { name: $("#implementerid").text() },
                success: function (dataBack) {
                    $(dataBack.data).each(function (index, item) {
                        ID = item.id;
                        savaDemand(ID);
                    });
                },
                error: function (error) {
                    alert(error.status + error.statusText)
                }
            });
        }
        //#endregion

        //#region 添加实施需求
        function savaDemand(ID) {
            if (panduan()) {
                $.ajax({
                    type: "PUT",
                    url: '/adddemand',
                    data: {
                        DemandNname: $('#demandname').val(),
                        RequirementsDescription: UE.getEditor('editor').getContent(),
                        Priority: $('#priority').find("option:selected").text(),
                        UserName: $('#username').val(),
                        Producer: $('#producer').val(),
                        ContactInformation: $('#information').val(),
                        ImplementerID: ID,
                        MakeTime: $('#shijiandata').text(),
                        VersionNumber: '1.0.0.0',
                        DeliveryDepartment: $("#bumen").find("option:selected").val(),
                        Status: '未通过',
                        ProductID: $("#productname").find("option:selected").val(),
                        Address: $("#address").val(),
                        DeleteStatus: 1
                    },
                    success: function (dataBack) {
                        if (dataBack.result == 1) {
                            layer.msg(dataBack.message, { icon: 1 });
                        }
                    },
                    error: function (error) {
                        layer.msg(dataBack.message, { icon: 2 });
                    }
                });
            }
        }
        //#endregion

        //#region  通过名称查询ID
        var draftID;
        var draftCharacter;
        function Insertdraft() {
            $.ajax({
                type: "POST",
                url: "/chaxunid",
                data: { name: $("#implementerid").text() },
                success: function (dataBack) {
                    $(dataBack.data).each(function (index, item) {
                        draftID = item.id;
                        savadraftDemand(draftID);
                    });
                },
                error: function (error) {
                    alert(error.status + error.statusText)
                }
            });
        }
        //#endregion

        //#region 添加实施需求
        function savadraftDemand(ID) {
            if (panduan()) {
                $.ajax({
                    type: "PUT",
                    url: '/adddemand',
                    data: {
                        DemandNname: $('#demandname').val(),
                        RequirementsDescription: UE.getEditor('editor').getContent(),
                        Priority: $('#priority').find("option:selected").text(),
                        UserName: $('#username').val(),
                        Producer: $('#producer').val(),
                        ContactInformation: $('#information').val(),
                        ImplementerID: ID,
                        MakeTime: $('#shijiandata').text(),
                        VersionNumber: '1.0.0.0',
                        DeliveryDepartment: $("#bumen").find("option:selected").val(),
                        Status: '未通过',
                        ProductID: $("#productname").find("option:selected").val(),
                        Address: $("#address").val(),
                        DeleteStatus: 2
                    },
                    success: function (dataBack) {
                        if (dataBack.result == 1) {
                            layer.msg(dataBack.message, { icon: 1 });
                        }
                    },
                    error: function (error) {
                        layer.msg(dataBack.message, { icon: 2 });
                    }
                });
            }
        }
        //#endregion

        //#region 判断是否为空跟清空数据
        function panduan() {
            var str = '';
            if ($('#username').val() == '') {
                str += "院方名称不能为空！";
                $('#username').focus();
                layer.msg(str, { icon: 2 });
                return false;
            }
            if ($('#producer').val() == '') {
                str += "客户姓名不能为空！";
                $('#producer').focus();
                layer.msg(str, { icon: 2 });
                return false;
            }
            if ($('#information').val() == '') {
                str += "联系方式不能为空！";
                $('#information').focus();
                layer.msg(str, { icon: 2 });
                return false;
            }
            else if (!$("#information").val().match(/^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/)) {
                str += "联系方式格式不正确！";
                $('#information').focus();
                layer.msg(str, { icon: 2 });
                return false;
            }
            if ($('#address').val() == '') {
                str += "院方地址不能为空！";
                $('#address').focus();
                layer.msg(str, { icon: 2 });
                return false;
            }
            if ($('#demandname').val() == '') {
                str += "项目名称不能为空！";
                $('#demandname').focus();
                layer.msg(str, { icon: 2 });
                return false;
            }
            if ($('#priority').find("option:selected").text() == '' || $('#priority').find("option:selected").text() == '请选择优先级') {
                str += "请选择优先级！";
                layer.msg(str, { icon: 2 });
                return false;
            }
            if ($("#bumen").find("option:selected").val() == '' || $("#bumen").find("option:selected").val() == '请选择交付的部门') {
                str += "请选择交付的部门！";
                layer.msg(str, { icon: 2 });
                return false;
            }
            else if ($("#bumen").val == 0) { 
                layer.msg("添加失败！", { icon: 2 });
                return false;
            }
            if (UE.getEditor('editor').getContent() == '') {
                str += "详细信息不能为空！";

                layer.msg(str, { icon: 2 });
                return false;
            }
            if ($('#productname').find("option:selected").text() == '' || $('#productname').find("option:selected").text() == '请选择产品名称' || $('#productname').val==0) {
                str += "请选择产品名称！";
                layer.msg(str, { icon: 2 });
                return false;
            } else if ($("#productname").val == 0) {
                layer.msg("添加失败！", { icon: 2 });
                return false;
            }
            return true;
        }
        function qingkong() {
            $('#username').val("");
            $('#producer').val("");
            $('#information').val("");
            $('#address').val("");
            $('#demandname').val("");
            $('#productname').find("option:selected").text("请选择产品名称");
            $('#priority').find("option:selected").text("请选择优先级");
            $("#bumen").find("option:selected").text("请选择交付的部门");
            UE.getEditor('editor').setContent("");
            $('#username').focus();
        }
        //#endregion

        //#region 查询需求信息
        function SelectDem() {
            $.ajax({
                type: "POST",
                url: '/selectdem',
                data: {
                    id: showdemval
                },
                success: function (dataBack) {
                    $(dataBack.data).each(function (index, item) {
                        $('#username').val(item.username);
                        $('#producer').val(item.producer);
                        $('#information').val(item.contactinformation);
                        $('#address').val(item.address);
                        $('#demandname').val(item.demandnname);
                        $('#productname option[value="0"]').text(item.productname);
                        $('#priority option[value="0"]').text(item.priority);
                        $('#bumen option[value="0"]').text(item.departmentname);
                        var cont = item.requirementsdescription;
                        var ue = UE.getEditor('editor');//初始化对象
                        ue.ready(function () {   //编辑器初始化完成再赋值
                            ue.setContent(cont); //赋值给UEditor
                        });
                    });
                    console.log(dataBack.data);
                },
                error: function (error) {
                    alert(error.status + error.statusText)
                }
            });
        }
        //#endregion
    </script>
</body>

</html>